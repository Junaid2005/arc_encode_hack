# MCP Setup Guide

This guide will help you set up MCP (Model Context Protocol) tools for your Streamlit chatbot.

## Expected Folder Structure

```
arc_encode_hack/
├── .env                          # Environment variables (create this)
├── blockchain_code/
│   ├── src/
│   │   ├── TrustMintSBT.sol      # SBT contract source
│   │   └── LendingPool.sol       # LendingPool contract source
│   └── out/                      # Generated by `forge build` (create this)
│       ├── TrustMintSBT.sol/
│       │   └── TrustMintSBT.json # Contains ABI + bytecode
│       └── LendingPool.sol/
│           └── LendingPool.json  # Contains ABI + bytecode
└── streamlit/
    └── src/
        └── frontend/
            └── components/
                └── chatbot_lib/
                    └── page.py   # Chatbot page with MCP integration
```

## Step 1: Compile Contracts

The ABI files must be generated by compiling your Solidity contracts with Foundry:

```bash
cd blockchain_code
forge build
```

This will create the `out/` directory with JSON files containing the contract ABIs.

**Verify the output:**
```bash
ls -la blockchain_code/out/TrustMintSBT.sol/TrustMintSBT.json
ls -la blockchain_code/out/LendingPool.sol/LendingPool.json
```

## Step 2: Create `.env` File

Create a `.env` file at the repository root with the following variables:

```bash
# Azure OpenAI (required for chatbot)
AZURE_OPENAI_ENDPOINT=https://your-endpoint.openai.azure.com
AZURE_OPENAI_KEY=your-api-key
AZURE_OPENAI_API_VERSION=2024-06-01
AZURE_OPENAI_CHAT_DEPLOYMENT=gpt-4o-mini

# Arc RPC (required)
ARC_TESTNET_RPC_URL=https://your-arc-rpc-url
PRIVATE_KEY=0xYourPrivateKey

# TrustMint SBT Contract (required for SBT tools)
SBT_ADDRESS=0xYourDeployedSBTContractAddress
TRUSTMINT_SBT_ABI_PATH=blockchain_code/out/TrustMintSBT.sol/TrustMintSBT.json

# LendingPool Contract (optional, for pool tools)
LENDING_POOL_ADDRESS=0xYourDeployedLendingPoolAddress
LENDING_POOL_ABI_PATH=blockchain_code/out/LendingPool.sol/LendingPool.json
USDC_ADDRESS=0xYourUSDCAddress
USDC_ABI_PATH=blockchain_code/out/USDC.sol/USDC.json

# Optional gas settings
ARC_GAS_LIMIT=200000
ARC_GAS_PRICE_GWEI=1
ARC_USDC_DECIMALS=6
```

## Step 3: Verify ABI File Format

The ABI JSON files should have this structure:

```json
{
  "abi": [
    {
      "type": "function",
      "name": "hasSbt",
      "inputs": [...],
      "outputs": [...],
      "stateMutability": "view"
    },
    ...
  ],
  "bytecode": "0x...",
  ...
}
```

The `load_contract_abi` function will automatically extract the `abi` field from the JSON.

## Step 4: Deploy Contracts

Deploy your contracts to the Arc testnet and update the addresses in `.env`:

- `SBT_ADDRESS`: Address of your deployed TrustMintSBT contract
- `LENDING_POOL_ADDRESS`: Address of your deployed LendingPool contract (optional)

## Step 5: Test MCP Tools

1. Start the Streamlit app:
   ```bash
   streamlit run streamlit/src/frontend/app.py
   ```

2. Navigate to the Chatbot page

3. The UI will show:
   - ✅ Success: MCP tools are loaded and available
   - ⚠️ Warning: Missing configuration with specific instructions
   - ❌ Error: Detailed error messages for any issues

## Troubleshooting

### "ABI file not found"
- Run `forge build` in the `blockchain_code` directory
- Verify the path in `.env` matches the actual file location
- Paths are resolved relative to the repository root

### "ABI file is not valid JSON"
- Check that the JSON file is valid
- Ensure `forge build` completed successfully
- Try deleting `out/` and rebuilding

### "Failed to build SBT toolkit"
- Verify the contract address is correct
- Ensure the contract is deployed on the network specified by `ARC_TESTNET_RPC_URL`
- Check that the ABI matches the deployed contract

### "No MCP tools are available"
- Check that at least one contract (SBT or LendingPool) is configured
- Verify all required environment variables are set
- Check the error messages in the UI for specific issues

## MCP Tool Registration

The following tools are automatically registered from your contract ABIs:

### TrustMintSBT Tools:
- `hasSbt`: Check if a wallet has an SBT (read-only)
- `getScore`: Get credit score for a wallet (read-only)
- `issueScore`: Issue/update a credit score (Owner role)
- `revokeScore`: Revoke a credit score (Owner role)

### LendingPool Tools:
- `availableLiquidity`: Check available liquidity (read-only)
- `lenderBalance`: Get lender balance (read-only)
- `getLoan`: Get loan details (read-only)
- `isBanned`: Check if borrower is banned (read-only)
- `deposit`: Deposit funds (Lender role)
- `withdraw`: Withdraw funds (Lender role)
- `openLoan`: Open a loan (Owner role)
- `repay`: Repay a loan (Borrower role)
- `checkDefaultAndBan`: Check default and ban borrower (Owner role)
- `unban`: Unban a borrower (Owner role)

Tools are registered based on functions found in the contract ABI. If a function exists in the ABI, the corresponding tool will be available.

